deploy:
  runs-on: self-hosted
  needs: build

  steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Set up kubectl config
    run: |
      mkdir -p $HOME/.kube
      cp $HOME/.kube/config $HOME/.kube/config
      chmod 600 $HOME/.kube/config

  - name: Set KUBECONFIG env var
    run: echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

  - name: Set up Helm
    uses: azure/setup-helm@v3

  - name: Deploy service-a
    run: helm upgrade --install service-a helm/charts/service-a --wait

  - name: Deploy service-b
    run: helm upgrade --install service-b helm/charts/service-b --wait

  - name: Verify deployment
    run: kubectl get pods -o wide

